liff.init({ liffId: liffId })
  .then(() => {
    if (!liff.isLoggedIn()) {
      liff.login();
    } else {
      liff.getAccessToken().then(accessToken => {
        // 獲取 access token
        // 使用 access token 呼叫 LINE 的 profile API 來獲取 UserID 和 displayName
        fetch('https://api.line.me/v2/profile', {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          })
          .then(res => res.json())
          .then(profile => {
            const userId = profile.userId;
            const displayName = profile.displayName;

            // 獲取 email (需要 OpenID Connect 權限)
            liff.getIDToken().then(idToken => {
              const decodedIdToken = liff.getDecodedIDToken();
              const email = decodedIdToken.email;

              // 將所有資料 (Email, UserID, displayName) POST 給 Make
              fetch('https://hook.us2.make.com/2fctyuomwdb0coppj1c7jy5zo4kyk7tt', { // <<-- 請替換成 Make 的 Webhook URL
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    email: email,
                    userId: userId,
                    displayName: displayName
                  })
                })
                .then(response => {
                  if (response.ok) {
                    // 如果成功，顯示成功訊息
                    document.body.innerHTML = "<p>帳號綁定成功！</p>";
                  } else {
                    document.body.innerHTML = "<p>綁定失敗，請重試。</p>";
                  }
                });
            }).catch(err => {
              // 處理沒有 Email 權限的錯誤
              document.body.innerHTML = "<p>請同意授權 Email。</p>";
            });
          });
      });
    }
  })
  .catch(err => {
    console.error('LIFF 初始化失敗:', err);
    document.body.innerHTML = "<p>LIFF 發生錯誤。</p>";
  });
